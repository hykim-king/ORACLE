<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.user">
 
 <sql id="searchCondition">
    <where>
                  <choose>
                    <when test="'10' == searchDiv and '' != searchWord">
                        name LIKE #{searchWord}||'%' 
                    </when>
                    <when test="'20' == searchDiv and '' != searchWord">
                        email LIKE #{searchWord}||'%' 
                    </when>
                    <when test="'30' == searchDiv and '' != searchWord">
                        user_id LIKE #{searchWord}||'%'   
                    </when>
                  </choose>
                </where>
 </sql>
 
 <select id="doRetrieve" parameterType="SignUpVO" resultType="SignUpVO">
		SELECT A.*, B.*
		FROM(
		    SELECT TT1.RNUM AS num,
		           tt1.user_id as userId,
		           tt1.name,
		           tt1.passwd,
		           tt1.hr_level as intLevel,
		           tt1.email,
		           tt1.login,
		           tt1.recommend,
		           -- 당일이면 시:분:, 당일이 아니면 년-월-일
		           DECODE(TO_CHAR(SYSDATE, 'YYYY-MM-DD'),TO_CHAR(tt1.reg_dt,'YYYY-MM-DD')
		                  ,TO_CHAR(tt1.reg_dt,'HH24:MI')
		                  ,TO_CHAR(tt1.reg_dt,'YYYY-MM-DD')) AS reg_dt
		    FROM(
		        SELECT ROWNUM as rnum, T1.*
		        FROM
		            (SELECT *
		            FROM hr_member
		            --WHERE : NAME(10), EMAIL(20), USER_ID(30)
		            <include refid="searchCondition"/>
		            ORDER BY reg_dt DESC
		            )T1
		<![CDATA[   WHERE ROWNUM <= #{pageSize} * (#{pageNo}-1) + #{pageSize} ]]> --종료 
		    )TT1
		<![CDATA[   WHERE rnum >= #{pageSize} * (#{pageNo}-1) + 1             ]]> --시작번호
		)A
		CROSS JOIN
		(   SELECT COUNT(*) totalCnt
		    FROM hr_member
		    --WHERE
        <include refid="searchCondition"/>
		)B

 </select>
 
 <update id="update" parameterType="SignUpVO">
    UPDATE hr_member          
    SET  name      =  #{name}     
		    ,passwd    =  #{passwd}     
		    ,hr_level  =  #{intLevel}     
		    ,login     =  #{login}     
		    ,recommend =  #{recommend}     
		    ,email     =  #{email}     
		    ,reg_dt    =  SYSDATE 
    WHERE                     
        user_id = #{userId}     
 </update>
 
 <select id="getAll" parameterType="SignUpVO" resultType="SignUpVO">
    SELECT t1.user_id as userId,                                 
	       t1.name,                                    
	       t1.passwd,                                  
	       t1.hr_level as intLevel,                                
	       t1.login,                                   
	       t1.recommend,                               
	       t1.email,                                   
	       TO_CHAR(t1.reg_dt, 'yyyy-mm-dd HH24') reg_dt
		FROM hr_member t1                                  
		WHERE user_id LIKE #{userId} ||'%'                         
		ORDER BY t1.user_id                                
  
 </select>
 
 <select id="getCount" parameterType="SignUpVO" resultType="int">
    SELECT COUNT(*) cnt      
    FROM hr_member           
    WHERE user_id LIKE #{userId}||'%' 
 
 </select>
 
  <resultMap type="SignUpVO" id="userMap">
    <result column="user_id"   property="userId"/>
    <result column="name"      property="name"/>
    <result column="passwd"    property="passwd"/>
    <result column="login"     property="login"/>
    <result column="recommend" property="recommend"/>
    <result column="email"     property="email"/>
    <result column="reg_dt"    property="reg_dt"/>
  </resultMap>
  
  <select id="get" parameterType="SignUpVO" resultMap="userMap">
    SELECT                                             
       t1.user_id,                                 
       t1.name,                                    
       t1.passwd,                                  
       t1.hr_level,                                
       t1.login,                                   
       t1.recommend,                               
       t1.email,                                   
       TO_CHAR(t1.reg_dt, 'yyyy-mm-dd HH24') reg_dt
    FROM                                               
      hr_member t1                                   
    WHERE  user_id = #{userId}                                 
    
  </select>

  <insert id="add" parameterType="SignUpVO">
	 INSERT INTO hr_member (
		   user_id,           
		   name,              
		   passwd,            
		   hr_level,          
		   login,             
		   recommend,         
		   email,             
		   reg_dt             
		) VALUES (             
		   #{userId},
       #{name},
       #{passwd},
       #{intLevel},
       #{login},
       #{recommend},
       #{email},     
		   SYSDATE            
		)                      
  </insert>
		    
  <delete id="deleteOne" parameterType="SignUpVO">
    DELETE FROM hr_member
    WHERE user_id = #{userId}
  </delete>
</mapper>